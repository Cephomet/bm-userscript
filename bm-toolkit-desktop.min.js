// ==UserScript==
// @name Battlemetrics Toolkit - Desktop (Auto Update)
// @namespace https://www.battlemetrics.com/
// @version 9.22
// @updateURL https://raw.githubusercontent.com/TempusOwl/bm-userscript/main/bm-toolkit-desktop.min.js
// @downloadURL https://raw.githubusercontent.com/TempusOwl/bm-userscript/main/bm-toolkit-desktop.min.js
// @description Modifies the rcon panel for battlemetrics to help color code important events and details about players.
// @author TempusOwl
// @match https://www.battlemetrics.com/*
// @match https://www.battlemetrics.com
// @icon https://www.google.com/s2/favicons?sz=64&domain=battlemetrics.com
// @grant GM_addStyle
// @run-at document-end
// ==/UserScript==
let version = "9.22", colors = {
    cTeamBluefor: "#e7a600",
    cTeamOpfor: "rgb(217,86,39)",
    cAdminName: "#00fff7",
    cbmAdmin: "#58ff47",
    cModAction: "#ff3333",
    cAdminAction: "#37ff00",
    cTeamKilled: "#ffcc00",
    cLeftServer: "#ff33cc",
    cJoined: "#919191",
    cGrayed: "#919191",
    cTracked: "#FF931A",
    cNoteIcon: "#FF201A"
}, sets = {
    teamKilled: new Set([ "team killed" ]),
    grayedOut: new Set([ "AFK - Thanks for playing!", "Please get a Squad Leader kit within 8 mins", "Final warning: Get Squad Leader kit within 5m", "SEEDING WHITELIST ACTIVE! Thanks for helping seed the server!", "You will be kicked in 2 minutes if you are still not in a squad", "To switch teams, please run the", "Check your seeding reward status via", "Trigger added flag LiQ Seeder" ]),
    trackedTriggers: new Set([ "[SL Kit]" ]),
    leftServer: new Set([ "left the server" ]),
    joinedServer: new Set([ "joined the server" ]),
    actionList: new Set([ "was warned", "was kicked", "was banned", "edited BattleMetrics Ban", "added BattleMetrics Ban", "deleted BattleMetrics Ban", "Trigger added flag Previously banned" ]),
    adminList: new Set([ "Aomm2025", "Archangel", "Basa_Doc", "Blackout", "Brennan", "budge", "Chaot3ch", "Cossack_440", "Digikind", "DontFaket", "E10", "El 24 throttle4u", "Exploits", "Gilly", "got2bhockey", "Hellsaber", "iCampHard", "JAMESTERRARIA", "Jonboy", "Kibz", "Kyle", "Mike.H", "Nightshade", "Outlast", "QTheEngineer", "Redneck", "Shaka", "sleepyguy1", "Skipper", "TempusOwl", "Too Many Cooks", "Valkyrie", "WatdaHek", "Wobblebob29", "Wolf Fang", "Θscar Mike", "xplay0321", "Chillz", "HellHound6396", "omgitsjesse", "MODERNMEGA", "Whip me more, Grandma", "Wjli13125", "Temper", "MadDawgMorales" ]),
    teamBluefor: new Set([ "Australian Defence Force", "British Armed Forces", "Canadian Armed Forces", "United States Army", "United States Marine Corps", "Turkish Land Forces" ]),
    teamOpfor: new Set([ "Russian Ground Forces", "Middle Eastern Alliance", "Insurgent Forces", "Irregular Militia Forces", "People's Liberation Army", "Russian Airborne Forces", "PLA Navy Marine Corps", "PLA Amphibious Ground Forces" ]),
    adminTerms: new Set([ "admin", "Admin", "ADMIN", "aDMIN", "to the other team.", ") was disbanded b", "requested a list of squads.", "requested a list of squads.", "set the next map to", "changed the map to", "requested the next map.", ") forced", "AdminRenameSquad", "(Global)", "executed Player Action Action", "requested the current map.", "restarted the match.", "Squad disband - SL", "was removed from their squad by Trigger.", "requested layer list.", "was removed from their squad by" ])
};

function mainScript() {
    setInterval(() => {
        document.querySelector("#RCONPlayerPage") ? ensureElementExists("copy-button", createCopyButton) : removeElementById("copy-button"), 
        replaceSteamIDSpans();
    }, 1e3);
}

function ensureElementExists(e, t) {
    document.getElementById(e) || t();
}

function removeElementById(e) {
    e = document.getElementById(e);
    e && e.remove();
}

function replaceSteamIDSpans() {
    document.querySelectorAll(".css-q39y9k").forEach(e => {
        var t = e.title;
        let o = document.createElement("a");
        // Clone span's attributes to the new anchor element
        Array.from(e.attributes).forEach(e => o.setAttribute(e.name, e.value)), 
        o.href = "https://communitybanlist.com/search/" + t, o.innerHTML = t, o.target = "_blank", 
        e.replaceWith(o);
    });
}

function createCopyButton() {
    var e = document.createElement("button");
    e.id = "copy-button", e.textContent = "Copy Player Info", e.classList.add("copy-button-style"), 
    document.body.appendChild(e), e.addEventListener("click", () => {
        var e = getInnerTextByTitle("765", "SteamID MISSING?"), t = getInnerTextByTitle("0002", "");
        copyToClipboard(`**User**: ${document.querySelector("#RCONPlayerPage > h1")?.innerText || "NAME MISSING?"} <${window.location.href}>
**IDs**: ${e} // ${t}
**Server**:
**Infraction**:
**Evidence Linked Below**:`);
    }), applyStyles();
}

function getInnerTextByTitle(e, t) {
    return document.querySelector(`[title*="${e}"]`)?.innerText || t;
}

function copyToClipboard(e) {
    var t = document.createElement("textarea");
    t.style.position = "fixed", // Avoids scrolling to the bottom
    t.style.opacity = "0", // Hides the element
    t.value = e, document.body.appendChild(t), t.select(), document.execCommand("copy"), 
    document.body.removeChild(t);
}

function applyStyles() {
    var e = document.createElement("style");
    e.innerHTML = ".copy-button-style {width: 125px;height: 35px;background: #4c82ffab;color: white;border: none;border-radius: 3px;box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);font-size: 14px;font-weight: bold;cursor: pointer;padding: 2px;position: absolute;top: 90px;left: 0;z-index: 99999;transition: background 0.3s, box-shadow 0.3s;}.copy-button-style:hover {background: #4c8aff;box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);}", 
    document.head.appendChild(e);
}

setInterval(function() {
    // Selectors
    var e = document.querySelectorAll(".css-1ewh5td"), t = document.querySelectorAll(".css-fj458c"), o = document.querySelectorAll(".css-ym7lu8"), r = document.querySelectorAll(".css-18s4qom");
    function n(e, o, r) {
        e.forEach(e => {
            for (var t of o) if (e.textContent.includes(t)) {
                e.style.color = r;
                break;
            }
        });
    }
    function s(e, o, r) {
        e.forEach(function(t) {
            o.forEach(function(e) {
                new RegExp("(\\b" + e + "\\b)|(\\b『LiQ』 ?" + e + "\\b)", "i").test(t.textContent) && (t.style.color = r);
            });
        });
    }
    // Apply color to the note icon
    document.querySelectorAll(".css-he5ni6").forEach(e => {
        e.style.color = colors.cNoteIcon; // Apply the icon color
    }), 
    // Apply colors based on phrases
    n(o, sets.adminTerms, colors.cAdminAction), n(o, sets.grayedOut, colors.cGrayed), 
    n(o, sets.joinedServer, colors.cJoined), n(o, sets.leftServer, colors.cLeftServer), 
    n(o, sets.actionList, colors.cModAction), n(o, sets.teamBluefor, colors.cTeamBluefor), 
    n(o, sets.teamOpfor, colors.cTeamOpfor), n(o, sets.teamKilled, colors.cTeamKilled), 
    n(o, sets.trackedTriggers, colors.cTracked), 
    // Apply colors to player names
    s(t, sets.adminList, colors.cAdminName), s(e, sets.adminList, colors.cAdminName), 
    l(document.querySelectorAll(".modal-title"), a.changeMapWarning), l(document.querySelectorAll(".css-4ey69y"), a.orgGroup), 
    l(document.querySelectorAll(".css-f5o5h6 a, .css-f5o5h6 button"), a.playerMenuDialog), 
    l(document.querySelectorAll(".css-1ixz43s a, .css-1ixz43s button"), a.playerMenuDialog), 
    l(document.querySelectorAll(".css-yun63y a, .css-yun63y button"), a.serverCommands), 
    // Highlights the Player Is Admin to neon in the players bar.
    r.forEach(e => {
        e.textContent.includes("Admin") && (e.style.color = colors.cbmAdmin);
    }), document.querySelectorAll(".css-z1s6qn").forEach(e => {
        var t = e.getAttribute("datetime"), t = new Date(t), o = (t.toLocaleString().split(" "), 
        new Date(e.getAttribute("title")));
        o.setHours(t.getHours(), t.getMinutes(), t.getSeconds()), e.setAttribute("title", o.toLocaleString());
    });
    let a = {
        changeMapWarning: [ {
            phrase: "Change Layer",
            styles: {
                color: "red",
                fontStyle: "bold",
                textAlign: "center",
                fontSize: "200pt"
            }
        }, {
            phrase: "Set Next Layer",
            styles: {
                color: "lime",
                fontStyle: "bold",
                textAlign: "center",
                fontSize: "24pt"
            }
        }, {
            phrase: "Kick",
            styles: {
                color: "orange",
                fontStyle: "bold",
                textAlign: "center",
                fontSize: "48pt"
            }
        }, {
            phrase: "Warn",
            styles: {
                color: "lime",
                fontStyle: "bold",
                textAlign: "center",
                fontSize: "24pt"
            }
        } ],
        orgGroup: [ {
            phrase: "Arma",
            styles: {
                background: "#333300"
            }
        }, {
            phrase: "Squad Mod",
            styles: {
                background: "#2b9937"
            }
        }, {
            phrase: "Comp",
            styles: {
                background: "lime"
            }
        }, {
            phrase: "Squad Admin",
            styles: {
                background: "#119ab7"
            }
        }, {
            phrase: "Rust Admin",
            styles: {
                background: "#672c00"
            }
        }, {
            phrase: "Org",
            styles: {
                background: "black"
            }
        }, {
            phrase: "Recruiter",
            styles: {
                background: "#cc6600"
            }
        }, {
            phrase: "Minecraft Admin",
            styles: {
                background: "#8d0cff"
            }
        }, {
            phrase: "Squad Event",
            styles: {
                background: "#660033"
            }
        } ],
        playerMenuDialog: [ {
            phrase: "Warn",
            styles: {
                color: "lime"
            }
        }, {
            phrase: "Squad List",
            styles: {
                color: "gold"
            }
        }, {
            phrase: "Kick",
            styles: {
                color: "orange"
            }
        }, {
            phrase: "Ban",
            styles: {
                color: "red"
            }
        }, {
            phrase: "Force Team Change",
            styles: {
                color: "#db4dff"
            }
        }, {
            phrase: "Remove Player from Squad",
            styles: {
                color: "#804d00"
            }
        }, {
            phrase: "Action - Reset Squad Name",
            styles: {
                color: "gold"
            }
        } ],
        serverCommands: [ {
            phrase: "Warn",
            styles: {
                color: "lime"
            }
        }, {
            phrase: "Kick",
            styles: {
                color: "orange"
            }
        }, {
            phrase: "Ban",
            styles: {
                color: "red"
            }
        }, {
            phrase: "Force Team Change",
            styles: {
                color: "#db4dff"
            }
        }, {
            phrase: "Remove Player from Squad",
            styles: {
                color: "#804d00"
            }
        }, {
            phrase: "Action - Reset Squad Name",
            styles: {
                color: "gold"
            }
        }, {
            phrase: "Next Layer",
            styles: {
                color: "lime",
                fontSize: "16pt"
            }
        }, {
            phrase: "Change Layer",
            styles: {
                color: "red",
                fontStyle: "bold",
                fontSize: "8pt"
            }
        }, {
            phrase: "Squad List",
            styles: {
                color: "gold",
                fontSize: "16pt"
            }
        } ]
    };
    function l(e, t) {
        e.forEach(o => {
            t.forEach(({
                phrase: e,
                styles: t
            }) => {
                o.textContent.includes(e) && Object.assign(o.style, t);
            });
        });
    }
}, 200), setTimeout(mainScript, 750), setTimeout(function() {
    // Apply styles
    Object.values({
        zShift: ".css-ym7lu8 {z-index: 2;}",
        zShiftTime: ".css-z1s6qn {z-index: 3;}",
        zShiftTimeDate: ".css-1jtoyp {z-index: 3;}",
        teamkillBar: ".css-1tuqie1 {background-color: #5600ff1a;width: 1920px}",
        moderationBar: ".css-1rwnm41 {background-color: #ff000008;width: 1920px;}",
        adminCam: ".css-1fy5con {background-color: #31e3ff21;width: 1920px}",
        nobranding: "html body div#root div.css-0.e1f2e1y80 div#RCONLayout.css-1qipodg nav.css-19lifo3 ul.css-16xvbhm li.css-1nxi32t a img#poweredbyovh {background-color: #31e3ff21;width: 1920px}"
    }).forEach(e => GM_addStyle(e));
    // Create a div to contain the buttons
    let s = document.createElement("div");
    s.style = "position: absolute; top: 10px; right: 5%; z-index: 99999;", document.body.appendChild(s), 
    // Create buttons
    [ {
        id: "NPFbutton",
        label: "N",
        url: "https://www.battlemetrics.com/rcon/servers/7871746",
        backgroundColor: "#187E00"
    }, {
        id: "TRbutton",
        label: "T",
        url: "https://www.battlemetrics.com/rcon/servers/7894269",
        backgroundColor: "orange"
    }, {
        id: "ban",
        label: "B",
        url: "https://www.battlemetrics.com/rcon/bans?filter%5Borganization%5D=17085&filter%5Bexpired%5D=true",
        backgroundColor: "red"
    }, {
        id: "lanes",
        label: "M",
        url: "https://squadmaps.com/",
        backgroundColor: "#7E6900"
    }, {
        id: "version",
        label: version,
        url: "https://raw.githubusercontent.com/TempusOwl/bm-userscript/main/bm-toolkit-desktop.min.js",
        backgroundColor: "black",
        fontSize: "6pt"
    } ].forEach(e => {
        return t = e.id, o = e.label, r = e.url, e = e.backgroundColor, (n = document.createElement("input")).setAttribute("type", "button"), 
        n.id = t, n.setAttribute("value", o), n.setAttribute("onclick", "window.open('" + r + "', '_blank')"), 
        n.style.width = "30px", n.style.marginRight = "5px", n.style.padding = "2px", 
        n.style.fontSize = "8pt", n.style.background = e, void s.appendChild(n);
        // Define button creation function
        var t, o, r, n;
        // Button details
    });
}, 1e3);